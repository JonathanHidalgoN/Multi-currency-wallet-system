# name: CD - Deploy to Production
#
# on:
#   push:
#     branches: [master, main]
#   workflow_dispatch:
#
# jobs:
#   deploy:
#     name: Deploy to ECS
#     runs-on: ubuntu-latest
#
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
#
#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ secrets.AWS_REGION }}
#
#       - name: Login to Amazon ECR
#         id: login-ecr
#         uses: aws-actions/amazon-ecr-login@v2
#
#       - name: Set up Java 21
#         uses: actions/setup-java@v4
#         with:
#           java-version: '21'
#           distribution: 'temurin'
#           cache: 'maven'
#
#       - name: Run tests
#         run: mvn test -B
#
#       - name: Build, tag, and push image to Amazon ECR
#         env:
#           ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
#           ECR_REPOSITORY: payflow/wallet-api
#           IMAGE_TAG: ${{ github.sha }}
#         run: |
#           # Build Docker image
#           docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
#           docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
#
#           # Push to ECR
#           docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
#           docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
#
#       - name: Deploy to ECS
#         env:
#           ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
#           ECS_SERVICE: ${{ secrets.ECS_SERVICE }}
#         run: |
#           # Force new deployment with latest image
#           aws ecs update-service \
#             --cluster $ECS_CLUSTER \
#             --service $ECS_SERVICE \
#             --force-new-deployment \
#             --region ${{ secrets.AWS_REGION }}
#
#       - name: Wait for deployment
#         env:
#           ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
#           ECS_SERVICE: ${{ secrets.ECS_SERVICE }}
#         run: |
#           aws ecs wait services-stable \
#             --cluster $ECS_CLUSTER \
#             --services $ECS_SERVICE \
#             --region ${{ secrets.AWS_REGION }}
#
#       - name: Get deployment status
#         env:
#           ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
#           ECS_SERVICE: ${{ secrets.ECS_SERVICE }}
#         run: |
#           aws ecs describe-services \
#             --cluster $ECS_CLUSTER \
#             --services $ECS_SERVICE \
#             --region ${{ secrets.AWS_REGION }} \
#             --query 'services[0].{desired:desiredCount,running:runningCount,pending:pendingCount}'
